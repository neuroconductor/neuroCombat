<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Harmonization of multi-site imaging data with ComBat • neuroCombat</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Harmonization of multi-site imaging data with ComBat">
<meta property="og:description" content="Harmonization of multi-site imaging data with ComBat.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">neuroCombat</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.13</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="articles/neuroCombat.html">Get started</a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">
<div id="combat-harmonization-in-r" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#combat-harmonization-in-r" class="anchor" aria-hidden="true"></a>ComBat harmonization in R</h1></div>
<div id="software-status" class="section level5">
<h5 class="hasAnchor">
<a href="#software-status" class="anchor" aria-hidden="true"></a>Software status</h5>
<table class="table">
<thead><tr class="header">
<th>Resource:</th>
<th>Travis CI</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Platform:</td>
<td>Linux</td>
</tr>
<tr class="even">
<td>R CMD check</td>
<td><a href="https://travis-ci.org/Jfortin1/neuroCombat_Rpackage" class="external-link"><img src="https://travis-ci.org/Jfortin1/neuroCombat_Rpackage.svg?branch=master" alt="Build status"></a></td>
</tr>
</tbody>
</table>
</div>
<div id="table-of-content" class="section level2">
<h2 class="hasAnchor">
<a href="#table-of-content" class="anchor" aria-hidden="true"></a>Table of content</h2>
<ul>
<li><a href="#id-section1">1. Installation</a></li>
<li><a href="#id-section2">2. Harmonization</a></li>
<li><a href="#id-section3">3. Visualization</a></li>
</ul>
<div id="id-section1"></div>



</div>
<div id="1-installation" class="section level2">
<h2 class="hasAnchor">
<a href="#1-installation" class="anchor" aria-hidden="true"></a>1. Installation</h2>
<p>neuroCombat can be installed in R by typing the following commands:</p>
<pre class="{r}"><code><a href="https://rdrr.io/r/base/library.html" class="external-link">library(devtools)
install_github("jfortin1/CombatHarmonization/R/neuroCombat")</a></code></pre>
<div id="id-section2"></div>

</div>
<div id="2-multi-site-harmonization" class="section level2">
<h2 class="hasAnchor">
<a href="#2-multi-site-harmonization" class="anchor" aria-hidden="true"></a>2. Multi-Site Harmonization</h2>
<p>ComBat estimates scanner-specific location and scale parameters, for each feature separately, and pools information across features using empirical Bayes to improve the estimation of those parameters for small sample size studies.</p>
<div id="21-full-combat-with-empirical-bayes" class="section level3">
<h3 class="hasAnchor">
<a href="#21-full-combat-with-empirical-bayes" class="anchor" aria-hidden="true"></a>2.1 Full ComBat with empirical Bayes</h3>
<p>The <code>neuroCombat</code> function is the main function. It requires two mandatory arguments: - a data matrix (p x n) <code>dat</code> for which the p rows are features, and the n columns are participants. - a numeric or character vector <code>batch</code> of length n indicating the site/scanner/study id.</p>
<p>For illustration purpose, let’s simulate an imaging dataset with n=10 participants, acquired on 2 scanners, with 5 participants each, with p=10000 voxels per scan.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">neuroCombat</span><span class="op">)</span>
<span class="va">p</span><span class="op">=</span><span class="fl">10000</span>
<span class="va">n</span><span class="op">=</span><span class="fl">10</span>
<span class="va">batch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">2</span>,<span class="fl">2</span>,<span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span> <span class="co">#Batch variable for the scanner id</span>
<span class="va">dat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">p</span><span class="op">*</span><span class="va">n</span><span class="op">)</span>, <span class="va">p</span>, <span class="va">n</span><span class="op">)</span> <span class="co">#Random Data matrix</span></code></pre></div>
<p>We use the function <code>neuroCombat</code> to harmonize the data across the 2 scanners:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data.harmonized</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/neuroCombat.html">neuroCombat</a></span><span class="op">(</span>dat<span class="op">=</span><span class="va">dat</span>, batch<span class="op">=</span><span class="va">batch</span><span class="op">)</span></code></pre></div>
<p>By default, this uses parametric adjustments. To following command must be used for non-parametric adjustments:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data.harmonized</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/neuroCombat.html">neuroCombat</a></span><span class="op">(</span>dat<span class="op">=</span><span class="va">dat</span>, batch<span class="op">=</span><span class="va">batch</span>, parametric<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>The harmonized matrix is stored in <code>data.harmonized$dat.combat</code>. The <code>data.harmonized</code> object also contains the different parameters estimated by ComBat: - <code>gamma.hat</code> and <code>delta.hat</code>: Estimated location and shift (L/S) parameters before empirical Bayes. - <code>gamma.star</code> and <code>delta.star</code>: Empirical Bayes estimated L/S parameters. - <code>gamma.bar</code>, <code>t2</code>, <code>a.prior</code> and <code>b.prior</code>: esimated prior distributions parameters.</p>
<p><code>neuroCombat</code> also accepts an optional argument, <code>mod</code>, which is a matrix containing biological covariates, including the outcome of interest. This is recommended to ensure that biological variability is preserved in the harmonization process. For instance, for a study with age and disease covariates,</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">age</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">82</span>,<span class="fl">70</span>,<span class="fl">68</span>,<span class="fl">66</span>,<span class="fl">80</span>,<span class="fl">69</span>,<span class="fl">72</span>,<span class="fl">76</span>,<span class="fl">74</span>,<span class="fl">80</span><span class="op">)</span> <span class="co"># Continuous variable</span>
<span class="va">disease</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="co"># Categorical variable</span></code></pre></div>
<p>we first create a model matrix for these two biological covariates using the <code>model.matrix</code> function:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>mod &lt;-<span class="st"> </span><span class="kw">model.matrix</span>(<span class="op">~</span>age<span class="op">+</span>disease)</span>
<span id="cb6-2"><a href="#cb6-2"></a>mod</span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="op">&gt;</span><span class="st"> </span>mod</span>
<span id="cb6-4"><a href="#cb6-4"></a>   (Intercept) age disease2</span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="dv">1</span>            <span class="dv">1</span>  <span class="dv">82</span>        <span class="dv">0</span></span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="dv">2</span>            <span class="dv">1</span>  <span class="dv">70</span>        <span class="dv">1</span></span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="dv">3</span>            <span class="dv">1</span>  <span class="dv">68</span>        <span class="dv">0</span></span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="dv">4</span>            <span class="dv">1</span>  <span class="dv">66</span>        <span class="dv">1</span></span>
<span id="cb6-9"><a href="#cb6-9"></a><span class="dv">5</span>            <span class="dv">1</span>  <span class="dv">80</span>        <span class="dv">0</span></span>
<span id="cb6-10"><a href="#cb6-10"></a><span class="dv">6</span>            <span class="dv">1</span>  <span class="dv">69</span>        <span class="dv">1</span></span>
<span id="cb6-11"><a href="#cb6-11"></a><span class="dv">7</span>            <span class="dv">1</span>  <span class="dv">72</span>        <span class="dv">0</span></span>
<span id="cb6-12"><a href="#cb6-12"></a><span class="dv">8</span>            <span class="dv">1</span>  <span class="dv">76</span>        <span class="dv">1</span></span>
<span id="cb6-13"><a href="#cb6-13"></a><span class="dv">9</span>            <span class="dv">1</span>  <span class="dv">74</span>        <span class="dv">0</span></span>
<span id="cb6-14"><a href="#cb6-14"></a><span class="dv">10</span>           <span class="dv">1</span>  <span class="dv">80</span>        <span class="dv">1</span></span></code></pre></div>
<p>The matrix <code>mod</code> is a n x 3 matrix, containing an intercept, age and a dummy variable for the second level of the disease variable (the first level is taken as the baseline group). Note that including an intercept in the model matrix will not change the results of the algorithm; ComBat automatically removes the intercept from the model matrix when fitting the models. We now harmonize the data:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">combat.harmonized</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/neuroCombat.html">neuroCombat</a></span><span class="op">(</span>dat<span class="op">=</span><span class="va">dat</span>, batch<span class="op">=</span><span class="va">batch</span>, mod<span class="op">=</span><span class="va">mod</span><span class="op">)</span></code></pre></div>
</div>
<div id="22-combat-without-empirical-bayes" class="section level3">
<h3 class="hasAnchor">
<a href="#22-combat-without-empirical-bayes" class="anchor" aria-hidden="true"></a>2.2 ComBat without empirical Bayes</h3>
<p>Sometimes, it is preferable not to pool information across features, for instance if: - (1) The number of features is substantially smaller than the number of participants (p &lt;&lt; n) or - (2) The prior distributions used in ComBat do not fit well the data - (3) The site effects are only present for a small subset of features</p>
<p>An example of (2) is studies with site/scanner effects that are highly heteregenous across features, for instance differential scanner effects between white matter (WM) or grey matter (GM) voxels exist. To run the ComBat model without empirical Bayes, which boils down to fitting a location/shift (L/S) model for each feature separately, the option <code>eb=FALSE</code> can be used:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data.harmonized</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/neuroCombat.html">neuroCombat</a></span><span class="op">(</span>dat<span class="op">=</span><span class="va">dat</span>, batch<span class="op">=</span><span class="va">batch</span>, eb<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
</div>
<div id="23-combat-with-mean-site-effects-adjustment-only-no-variance-adjustment" class="section level3">
<h3 class="hasAnchor">
<a href="#23-combat-with-mean-site-effects-adjustment-only-no-variance-adjustment" class="anchor" aria-hidden="true"></a>2.3 ComBat with mean site effects adjustment only (no variance adjustment)</h3>
<div id="id-section3"></div>

</div>
</div>
<div id="3-visualization" class="section level2">
<h2 class="hasAnchor">
<a href="#3-visualization" class="anchor" aria-hidden="true"></a>3. Visualization</h2>
<p>Coming soon.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="https://www.r-project.org/Licenses/Artistic-2.0">Artistic-2.0</a></li>
</ul>
</div>


<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Jean-Philippe Fortin <br><small class="roles"> Author, maintainer </small>  </li>
</ul>
</div>



  </div>
</div>


      <footer><div class="copyright">
  <p></p>
<p>Developed by Jean-Philippe Fortin.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 1.6.1.9001.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
